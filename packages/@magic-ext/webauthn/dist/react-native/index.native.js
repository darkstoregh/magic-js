"use strict";var g=Object.defineProperty;var w=Object.getOwnPropertyDescriptor;var R=Object.getOwnPropertyNames;var A=Object.prototype.hasOwnProperty;var W=(e,a)=>{for(var r in a)g(e,r,{get:a[r],enumerable:!0})},C=(e,a,r,n)=>{if(a&&typeof a=="object"||typeof a=="function")for(let t of R(a))!A.call(e,t)&&t!==r&&g(e,t,{get:()=>a[t],enumerable:!(n=w(a,t))||n.enumerable});return e};var m=e=>C(g({},"__esModule",{value:!0}),e);var c=(e,a,r)=>new Promise((n,t)=>{var s=o=>{try{u(r.next(o))}catch(l){t(l)}},i=o=>{try{u(r.throw(o))}catch(l){t(l)}},u=o=>o.done?n(o.value):Promise.resolve(o.value).then(s,i);u((r=r.apply(e,a)).next())});var v={};W(v,{WebAuthnExtension:()=>b});module.exports=m(v);var _=require("@magic-sdk/commons");var E="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";function d(e){let a,r=e.length%3,n="",t,s;function i(o){return E.charAt(o)}function u(o){return i(o>>18&63)+i(o>>12&63)+i(o>>6&63)+i(o&63)}for(a=0,s=e.length-r;a<s;a+=3)t=(e[a]<<16)+(e[a+1]<<8)+e[a+2],n+=u(t);switch(r){case 1:t=e[e.length-1],n+=i(t>>2),n+=i(t<<4&63),n+="==";break;case 2:t=(e[e.length-2]<<8)+e[e.length-1],n+=i(t>>10),n+=i(t>>4&63),n+=i(t<<2&63),n+="=";break;default:break}return n}function h(e){return d(e).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}function f(e){return d(e).replace(/\+/g,"-").replace(/\//g,"_")}function x(e){return Array.from(e).map(function(a){return`0${a.toString(16)}`.substr(-2)}).join("")}var p=e=>{let a=new Uint8Array(e.response.attestationObject),r=new Uint8Array(e.response.clientDataJSON),n=new Uint8Array(e.rawId),t=e.getClientExtensionResults();return{id:e.id,rawId:h(n),type:e.type,attObj:h(a),clientData:h(r),registrationClientExtensions:JSON.stringify(t)}},y=e=>{let a=new Uint8Array(e.response.authenticatorData),r=new Uint8Array(e.response.clientDataJSON),n=new Uint8Array(e.rawId),t=new Uint8Array(e.response.signature),s=e.getClientExtensionResults();return{id:e.id,rawId:h(n),type:e.type,authData:f(a),clientData:f(r),signature:x(t),assertionClientExtensions:JSON.stringify(s)}};var b=class extends _.Extension.Internal{constructor(){super(...arguments);this.name="webauthn";this.config={}}createWebAuthnNotSupportError(){this.createError("WEBAUTHN_NOT_SUPPORTED","WebAuthn is not supported in this device.",{})}createWebAuthCreateCredentialError(r){this.createError("WEBAUTHN_CREATE_CREDENTIAL_ERROR",`Error creating credential: ${r}`,{})}registerNewUser(r){return c(this,null,function*(){if(!window.PublicKeyCredential)throw this.createWebAuthnNotSupportError();let{username:n,nickname:t=""}=r,s=yield this.request(this.utils.createJsonRpcRequestPayload("magic_auth_webauthn_registration_start",[{username:n}])),i;try{i=yield navigator.credentials.create({publicKey:s.credential_options})}catch(u){throw this.createWebAuthCreateCredentialError(u)}return this.request(this.utils.createJsonRpcRequestPayload("magic_auth_webauthn_register",[{id:s.id,nickname:t,transport:i.response.getTransports(),user_agent:navigator.userAgent,registration_response:p(i)}]))})}login(r){return c(this,null,function*(){if(!window.PublicKeyCredential)throw this.createWebAuthnNotSupportError();let{username:n}=r,t=yield this.request(this.utils.createJsonRpcRequestPayload("magic_auth_login_with_web_authn",[{username:n}])),s;try{s=yield navigator.credentials.get({publicKey:t})}catch(i){throw this.createWebAuthCreateCredentialError(i)}return this.request(this.utils.createJsonRpcRequestPayload("magic_auth_login_with_webauthn_verify",[{username:n,assertion_response:y(s)}]))})}updateInfo(r){let{id:n,nickname:t}=r,s=this.utils.createJsonRpcRequestPayload("magic_user_update_webauthn",[{webAuthnCredentialsId:n,nickname:t}]);return this.request(s)}unregisterDevice(r){let n=this.utils.createJsonRpcRequestPayload("magic_user_unregister_webauthn",[{webAuthnCredentialsId:r}]);return this.request(n)}registerNewDevice(r=""){return c(this,null,function*(){if(!window.PublicKeyCredential)throw this.createWebAuthnNotSupportError();let n=yield this.request(this.utils.createJsonRpcRequestPayload("magic_auth_register_webauthn_device_start",[])),t;try{t=yield navigator.credentials.create({publicKey:n.credential_options})}catch(s){throw this.createWebAuthCreateCredentialError(s)}return this.request(this.utils.createJsonRpcRequestPayload("magic_auth_register_webauthn_device",[{nickname:r,transport:t.response.getTransports(),user_agent:navigator.userAgent,registration_response:p(t)}]))})}getMetadata(){let r=this.utils.createJsonRpcRequestPayload("magic_user_get_webauthn_credentials",[]);return this.request(r)}};
//# sourceMappingURL=index.native.js.map
