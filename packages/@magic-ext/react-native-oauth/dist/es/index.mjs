var l=(t,e,r)=>new Promise((u,s)=>{var a=o=>{try{c(r.next(o))}catch(n){s(n)}},p=o=>{try{c(r.throw(o))}catch(n){s(n)}},c=o=>o.done?u(o.value):Promise.resolve(o.value).then(a,p);c((r=r.apply(t,e)).next())});import*as I from"expo-web-browser";import{Extension as x}from"@magic-sdk/react-native";import _ from"crypto-js/sha256";import v from"crypto-js/enc-base64";var m="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",h=typeof window!="undefined"&&!!window.crypto,U=h&&!!window.crypto.subtle;function O(t){return Array.from(t).map(e=>m[e%m.length]).join("")}function f(t){let e=r=>r.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"");if(t instanceof ArrayBuffer){let r=new Uint8Array(t),u=Array.from(r).map(a=>String.fromCharCode(a)).join(""),s=btoa(u);return e(s)}return e(v.stringify(t))}function w(t){return l(this,null,function*(){if(U){let e=new TextEncoder().encode(t);return crypto.subtle.digest("SHA-256",e).then(f)}return f(_(t))})}function y(t){let e=new Uint8Array(t);if(h)window.crypto.getRandomValues(e);else for(let r=0;r<t;r+=1)e[r]=Math.floor(Math.random()*Math.floor(255));return O(e)}function R(){return l(this,null,function*(){let t=y(128),e=y(128),r=yield w(e);return{verifier:e,challenge:r,state:t}})}var A=(e=>(e.ParseRedirectResult="magic_oauth_parse_redirect_result",e))(A||{}),C=(i=>(i.InvalidRequest="invalid_request",i.InvalidClient="invalid_client",i.InvalidScope="invalid_scope",i.InvalidGrant="invalid_grant",i.UnauthorizedClient="unauthorized_client",i.UnsupportedResponseType="unsupported_response_type",i.UnsupportedGrantType="unsupported_grant_type",i.UnsupportedTokenType="unsupported_token_type",i.AccessDenied="access_denied",i.ServerError="server_error",i.TemporarilyUnavailable="temporarily_unavailable",i))(C||{});var b=class extends x.Internal{constructor(){super(...arguments);this.name="oauth";this.config={};this.compat={"magic-sdk":!1,"@magic-sdk/react-native":">=2.7.0"}}loginWithPopup(r){return this.utils.createPromiEvent((u,s)=>l(this,null,function*(){try{let{provider:a,query:p,redirectURI:c}=yield E.call(this,r),o=`https://auth.magic.link/v1/oauth2/${a}/start?${p}`,n=yield I.openAuthSessionAsync(o,c,{});if(n.type==="success"){let d=new URL(n.url).search;u(D.call(this,d.toString()))}else s(this.createError(n.type,"User has cancelled the authentication",{}))}catch(a){s(this.createError(a.message,"An error has occurred",{err:a}))}}))}},g="oauth_redirect_metadata";function E(t){return l(this,null,function*(){yield this.utils.storage.removeItem(g);let{provider:e,redirectURI:r,scope:u,loginHint:s}=t,{verifier:a,challenge:p,state:c}=yield R(),o=JSON.stringify({verifier:a,state:c});return yield this.utils.storage.setItem(g,o),{query:[`magic_api_key=${encodeURIComponent(this.sdk.apiKey)}`,`magic_challenge=${encodeURIComponent(p)}`,`state=${encodeURIComponent(c)}`,`platform=${encodeURIComponent("rn")}`,u&&`scope=${encodeURIComponent(u.join(" "))}`,r&&`redirect_uri=${encodeURIComponent(r)}`,s&&`login_hint=${encodeURIComponent(s)}`].reduce((d,i)=>i?`${d}&${i}`:d),provider:e,redirectURI:r}})}function D(t){return this.utils.createPromiEvent((e,r)=>l(this,null,function*(){var d;let u=yield this.utils.storage.getItem(g),{verifier:s,state:a}=JSON.parse(u);this.utils.storage.removeItem(g);let p=this.utils.createJsonRpcRequestPayload("magic_oauth_parse_redirect_result",[t,s,a]),c=yield this.request(p),o=c,n=c;n.error&&r(this.createError(n.error,(d=n.error_description)!=null?d:"An error occurred.",{errorURI:n.error_uri,provider:n.provider})),e(o)}))}export{C as OAuthErrorCode,b as OAuthExtension,A as OAuthPayloadMethods,E as createURI,D as getResult};
//# sourceMappingURL=index.mjs.map
