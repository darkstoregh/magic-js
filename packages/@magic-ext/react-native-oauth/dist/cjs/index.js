"use strict";var P=Object.create;var g=Object.defineProperty;var T=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var k=Object.getPrototypeOf,B=Object.prototype.hasOwnProperty;var $=(e,r)=>{for(var t in r)g(e,t,{get:r[t],enumerable:!0})},R=(e,r,t,s)=>{if(r&&typeof r=="object"||typeof r=="function")for(let n of S(r))!B.call(e,n)&&n!==t&&g(e,n,{get:()=>r[n],enumerable:!(s=T(r,n))||s.enumerable});return e};var f=(e,r,t)=>(t=e!=null?P(k(e)):{},R(r||!e||!e.__esModule?g(t,"default",{value:e,enumerable:!0}):t,e)),M=e=>R(g({},"__esModule",{value:!0}),e);var l=(e,r,t)=>new Promise((s,n)=>{var c=a=>{try{u(t.next(a))}catch(i){n(i)}},p=a=>{try{u(t.throw(a))}catch(i){n(i)}},u=a=>a.done?s(a.value):Promise.resolve(a.value).then(c,p);u((t=t.apply(e,r)).next())});var L={};$(L,{OAuthErrorCode:()=>w,OAuthExtension:()=>h,OAuthPayloadMethods:()=>y,createURI:()=>E,getResult:()=>D});module.exports=M(L);var C=f(require("expo-web-browser")),x=require("@magic-sdk/react-native");var _=f(require("crypto-js/sha256")),v=f(require("crypto-js/enc-base64"));var A="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",U=typeof window!="undefined"&&!!window.crypto,q=U&&!!window.crypto.subtle;function H(e){return Array.from(e).map(r=>A[r%A.length]).join("")}function b(e){let r=t=>t.replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"");if(e instanceof ArrayBuffer){let t=new Uint8Array(e),s=Array.from(t).map(c=>String.fromCharCode(c)).join(""),n=btoa(s);return r(n)}return r(v.default.stringify(e))}function N(e){return l(this,null,function*(){if(q){let r=new TextEncoder().encode(e);return crypto.subtle.digest("SHA-256",r).then(b)}return b((0,_.default)(e))})}function I(e){let r=new Uint8Array(e);if(U)window.crypto.getRandomValues(r);else for(let t=0;t<e;t+=1)r[t]=Math.floor(Math.random()*Math.floor(255));return H(r)}function O(){return l(this,null,function*(){let e=I(128),r=I(128),t=yield N(r);return{verifier:r,challenge:t,state:e}})}var y=(r=>(r.ParseRedirectResult="magic_oauth_parse_redirect_result",r))(y||{}),w=(o=>(o.InvalidRequest="invalid_request",o.InvalidClient="invalid_client",o.InvalidScope="invalid_scope",o.InvalidGrant="invalid_grant",o.UnauthorizedClient="unauthorized_client",o.UnsupportedResponseType="unsupported_response_type",o.UnsupportedGrantType="unsupported_grant_type",o.UnsupportedTokenType="unsupported_token_type",o.AccessDenied="access_denied",o.ServerError="server_error",o.TemporarilyUnavailable="temporarily_unavailable",o))(w||{});var h=class extends x.Extension.Internal{constructor(){super(...arguments);this.name="oauth";this.config={};this.compat={"magic-sdk":!1,"@magic-sdk/react-native":">=2.7.0"}}loginWithPopup(t){return this.utils.createPromiEvent((s,n)=>l(this,null,function*(){try{let{provider:c,query:p,redirectURI:u}=yield E.call(this,t),a=`https://auth.magic.link/v1/oauth2/${c}/start?${p}`,i=yield C.openAuthSessionAsync(a,u,{});if(i.type==="success"){let d=new URL(i.url).search;s(D.call(this,d.toString()))}else n(this.createError(i.type,"User has cancelled the authentication",{}))}catch(c){n(this.createError(c.message,"An error has occurred",{err:c}))}}))}},m="oauth_redirect_metadata";function E(e){return l(this,null,function*(){yield this.utils.storage.removeItem(m);let{provider:r,redirectURI:t,scope:s,loginHint:n}=e,{verifier:c,challenge:p,state:u}=yield O(),a=JSON.stringify({verifier:c,state:u});return yield this.utils.storage.setItem(m,a),{query:[`magic_api_key=${encodeURIComponent(this.sdk.apiKey)}`,`magic_challenge=${encodeURIComponent(p)}`,`state=${encodeURIComponent(u)}`,`platform=${encodeURIComponent("rn")}`,s&&`scope=${encodeURIComponent(s.join(" "))}`,t&&`redirect_uri=${encodeURIComponent(t)}`,n&&`login_hint=${encodeURIComponent(n)}`].reduce((d,o)=>o?`${d}&${o}`:d),provider:r,redirectURI:t}})}function D(e){return this.utils.createPromiEvent((r,t)=>l(this,null,function*(){var d;let s=yield this.utils.storage.getItem(m),{verifier:n,state:c}=JSON.parse(s);this.utils.storage.removeItem(m);let p=this.utils.createJsonRpcRequestPayload("magic_oauth_parse_redirect_result",[e,n,c]),u=yield this.request(p),a=u,i=u;i.error&&t(this.createError(i.error,(d=i.error_description)!=null?d:"An error occurred.",{errorURI:i.error_uri,provider:i.provider})),r(a)}))}0&&(module.exports={OAuthErrorCode,OAuthExtension,OAuthPayloadMethods,createURI,getResult});
//# sourceMappingURL=index.js.map
